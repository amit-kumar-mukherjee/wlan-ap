From b14c0b96644cf86b36b0e60da800dd11733b26a9 Mon Sep 17 00:00:00 2001
From: Chaitanya Godavarthi <chaitanya.kiran@netexperience.com>
Date: Tue, 14 Sep 2021 10:23:49 -0400
Subject: [PATCH] ubus notify when ethernet ports change state

Signed-off-by: Chaitanya Godavarthi <chaitanya.kiran@netexperience.com>
---
 .../0106-add-ubus-notify-eth-state.patch      | 65 +++++++++++++++++++
 1 file changed, 65 insertions(+)
 create mode 100644 package/network/config/netifd/patches/0106-add-ubus-notify-eth-state.patch

diff --git a/package/network/config/netifd/patches/0106-add-ubus-notify-eth-state.patch b/package/network/config/netifd/patches/0106-add-ubus-notify-eth-state.patch
new file mode 100644
index 0000000000..3c8eaa530d
--- /dev/null
+++ b/package/network/config/netifd/patches/0106-add-ubus-notify-eth-state.patch
@@ -0,0 +1,65 @@
+Index: netifd-2019-08-05-5e02f944/device.c
+===================================================================
+--- netifd-2019-08-05-5e02f944.orig/device.c
++++ netifd-2019-08-05-5e02f944/device.c
+@@ -29,6 +29,7 @@
+ #include "netifd.h"
+ #include "system.h"
+ #include "config.h"
++#include "ubus.h"
+ 
+ static struct list_head devtypes = LIST_HEAD_INIT(devtypes);
+ static struct avl_tree devices;
+@@ -638,6 +639,7 @@ void device_set_present(struct device *d
+ 
+ void device_set_link(struct device *dev, bool state)
+ {
++	ubus_link_state_notify(dev, state);
+ 	if (dev->link_active == state)
+ 		return;
+ 
+Index: netifd-2019-08-05-5e02f944/ubus.c
+===================================================================
+--- netifd-2019-08-05-5e02f944.orig/ubus.c
++++ netifd-2019-08-05-5e02f944/ubus.c
+@@ -817,6 +817,29 @@ netifd_dump_status(struct interface *ifa
+ 		netifd_add_interface_errors(&b, iface);
+ }
+ 
++void ubus_link_state_notify(struct device *dev, bool state)
++{
++	struct interface *iface = NULL; 
++	/* proceed to notify if eth link state change and bridge change */
++	if((strncmp(dev->ifname, "eth", 3) && (dev->link_active == state)) &&
++	   strncmp(dev->ifname, "br-wan", 6) &&
++	   strncmp(dev->ifname, "br-lan", 6))
++		return;
++	netifd_log_message(L_NOTICE, "%s:%s\n", __func__, dev->ifname);
++
++	vlist_for_each_element(&interfaces, iface, node) {
++		if( !strncmp(iface->name, "wan", 3) ||
++		    !strncmp(iface->name, "lan", 3) ||
++		    !strncmp(iface->name, "eth", 3)) {
++			blob_buf_init(&b, 0);
++			blobmsg_add_string(&b, "interface", iface->name);
++			netifd_dump_status(iface);
++			ubus_notify(ubus_ctx, &iface->ubus, "interface.update",
++				    b.head, -1);
++		}
++	}
++}
++
+ static int
+ netifd_handle_status(struct ubus_context *ctx, struct ubus_object *obj,
+ 		     struct ubus_request_data *req, const char *method,
+Index: netifd-2019-08-05-5e02f944/ubus.h
+===================================================================
+--- netifd-2019-08-05-5e02f944.orig/ubus.h
++++ netifd-2019-08-05-5e02f944/ubus.h
+@@ -22,5 +22,6 @@ void netifd_ubus_add_interface(struct in
+ void netifd_ubus_remove_interface(struct interface *iface);
+ void netifd_ubus_interface_event(struct interface *iface, bool up);
+ void netifd_ubus_interface_notify(struct interface *iface, bool up);
++void ubus_link_state_notify(struct device *dev, bool state);
+ 
+ #endif
-- 
2.25.1

